<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple Polygon</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
    <script>
    var map;
    var markings=[];

    function pointInPolygon(point, polygon, name, Vertex) {
        var pov = Vertex;
        if (pov == true && pointOnVertex(point, polygon) == true) {
            return true;
        }
        intersections = 0; 
        vertices_count = polygon.length;
 
        for (var i=1; i < vertices_count; i++) {
            var vertex1 = polygon[i-1]; 
            var vertex2 = polygon[i];
            if (vertex1.y == vertex2.y && vertex1.y == point.y && point.x > Math.min(vertex1.x, vertex2.x) && point.x < Math.max(vertex1.x,vertex2.x)) { // Check if point is on an horizontal polygon boundary
                return true;
            }
            if (point.y > Math.min(vertex1.y, vertex2.y) && point.y <= Math.max(vertex1.y, vertex2.y) && point.x <= Math.max(vertex1.x, vertex2.x) && vertex1.y != vertex2.y) { 
                var xinters = (point.y - vertex1.y) * (vertex2.x - vertex1.x) / (vertex2.y - vertex1.y) + vertex1.x; 
                if (xinters == point.x) { 
                    
                    return true;
                }
                if (vertex1.x == vertex2.x || point.x <= xinters) {
                    intersections++; 
                }
            } 
        } 
        if (intersections % 2 != 0) {
            return true;
        } else {
            return false;
        }
    }
 
    function pointOnVertex(point, vertices) {
        for(var i=0;i<vertices.length;i++) {
            if (point.x == vertices[i].x && point.y==vertices[i].y) {
                return true;
            }
        }
 
    }
    function getConstituency(lat,lng){
    	var gp=new Parse.GeoPoint({latitude: lat, longitude: lng});
    	var fb=new google.maps.LatLng(lat, lng);
    	ListItem = Parse.Object.extend("Constituency");
        query = new Parse.Query(ListItem);
        query.limit(7);
        query.near("center", gp);
        query.find({
              success: function(results) {
                    
                    poly=[];
                    for(var i=0;i<results.length;i++){
                    	console.log("Close to: "+results[i].get("name"));
                    	var Coords=[];
                    	var points=results[i].get("points");
	                    console.log(points.length);
	                    for (var j = 0; j < points.length; j++) { 
	                        Coords.push(new google.maps.LatLng(points[j].latitude,points[j].longitude));
	                    }
	                    Poly = new google.maps.Polygon({
		                      paths: Coords,
		                      strokeColor: '#FF0000',
		                      strokeOpacity: 0.8,
		                      strokeWeight: 2,
		                      constituency: results[i].get("name"),
		                      fillColor: '#FF0000',
		                      fillOpacity: 0.35
		                    });
	                    poly.push(Poly);
	                    console.log("Polygon Created!");
	                                        
                    }
                    for(var s=0;s<poly.length;s++){
	                	if(google.maps.geometry.poly.containsLocation(fb, poly[s])==true){
			                alert("I am in "+poly[s].constituency);
			           }
	                }  
                },
              error: function(error) {
                    console.log("Error:"+error.message);
              }
        });
    	
    }

    function plotConstituency(c){
        console.log("Lets Plot a Constituency");
        ListItem = Parse.Object.extend("Constituency");
        query = new Parse.Query(ListItem);
        query.equalTo("index", c);    
        query.find({
              success: function(results) {
                    console.log("Starting Plotting: "+results[0].get("name"));
                    var Coords=[];
                    var pints=[];
                    var points=results[0].get("points");
                    console.log(points.length);
                    for (var i = 0; i < points.length; i++) { 
                        Coords.push(new google.maps.LatLng(points[i].latitude,points[i].longitude));
                        pints.push({x:points[i].latitude,y:points[i].longitude});
                    }
                    console.log("First:"+points[0].longitude);
                    console.log("Last:"+points[points.length-1].longitude);
                    Poly = new google.maps.Polygon({
                      paths: Coords,
                      strokeColor: '#FF0000',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
                      constituency: results[0].get("name"),
                      fillColor: '#FF0000',
                      fillOpacity: 0.35
                    });
                    console.log("Polygon Created!");
                    Poly.setMap(map);                      
                    markings.push([pints,results[0].get("name")]);                    
                },
              error: function(error) {
                    console.log("Error:"+error.message);
              }
        });
    }

    function initialize() {
      Parse.initialize("km3gtnQr78DlhMMWqMNCwDn4L1nR6zdBcMqzkUXt", "BS9nk6ykTKiEabLX1CwDzy4FLT1UryRR6KsdRPJI");
      
      var mapOptions = {
        zoom: 11,
        center: new google.maps.LatLng(28.667508, 77.121255),
        mapTypeId: google.maps.MapTypeId.TERRAIN
      };
      
      map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);
      
      for(var i=1;i<71;i++){
        plotConstituency(i);
      }
      
      var dragable_marker = new google.maps.Marker({
        position : new google.maps.LatLng(28.667508, 77.1212552),
        map : map,
        draggable : true
      });

      google.maps.event.addListener( dragable_marker, 'dragend', function( e ) {
         	//getConstituency(dragable_marker.getPosition().lat(),dragable_marker.getPosition().lng());
          
           pt={
             x:dragable_marker.getPosition().lat(),
             y:dragable_marker.getPosition().lng()
           }
           
           Parse.Cloud.run('getConstituencyName', {lat: pt.x ,lng: pt.y }, {
              success: function(result) {
                console.log(result);
              },
              error: function(error) {
                console.log(error);
              }
            });
         
      });

    }

    google.maps.event.addDomListener(window, 'load', initialize);

    </script>

  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>

