<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple Polygon</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
    <script>
    var map;
    var markings=[];
    function getConstituency(lat,lng){
    	var gp=new Parse.GeoPoint({latitude: lat, longitude: lng});
    	var fb=new google.maps.LatLng(lat, lng);
    	ListItem = Parse.Object.extend("Polygon");
        query = new Parse.Query(ListItem);
        query.limit(7);
        query.near("center", gp);
        query.find({
              success: function(results) {
                    
                    poly=[];
                    for(var i=0;i<results.length;i++){
                    	console.log("Close to: "+results[i].get("name"));
                    	var Coords=[];
                    	var points=results[i].get("points");
	                    console.log(points.length);
	                    for (var j = 0; j < points.length; j++) { 
	                        Coords.push(new google.maps.LatLng(points[j].latitude,points[j].longitude));
	                    }
	                    Poly = new google.maps.Polygon({
		                      paths: Coords,
		                      strokeColor: '#FF0000',
		                      strokeOpacity: 0.8,
		                      strokeWeight: 2,
		                      constituency: results[i].get("name"),
		                      fillColor: '#FF0000',
		                      fillOpacity: 0.35
		                    });
	                    poly.push(Poly);
	                    console.log("Polygon Created!");
	                                        
                    }
                    for(var s=0;s<poly.length;s++){
	                	if(google.maps.geometry.poly.containsLocation(fb, poly[s])==true){
			                alert("I am in "+poly[s].constituency);
			           }
	                }  
                },
              error: function(error) {
                    console.log("Error:"+error.message);
              }
        });
    	
    }

    function plotConstituency(c){
        console.log("Lets Plot a Constituency");
        ListItem = Parse.Object.extend("Polygon");
        query = new Parse.Query(ListItem);
        query.equalTo("index", c);    
        query.find({
              success: function(results) {
                    console.log("Starting Plotting: "+results[0].get("name"));
                    var Coords=[];
                    
                    var points=results[0].get("points");
                    console.log(points.length);
                    for (var i = 0; i < points.length; i++) { 
                    	
                        Coords.push(new google.maps.LatLng(points[i].latitude,points[i].longitude));
                    }
                    Poly = new google.maps.Polygon({
                      paths: Coords,
                      strokeColor: '#FF0000',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
                      constituency: results[0].get("name"),
                      fillColor: '#FF0000',
                      fillOpacity: 0.35
                    });
                    console.log("Polygon Created!");
                    Poly.setMap(map);                      
                    markings.push(Poly);
                    
                },
              error: function(error) {
                    console.log("Error:"+error.message);
              }
        });
    }

    function initialize() {
      Parse.initialize('jlQ5tv6KHzbRWhGcI0qXLAMsCVPf45efzqHBaqOt', 'q6AfL8e41Rl1vtYrjsDOVLpdFkgxT1mAH87wkqZH');
      
      var mapOptions = {
        zoom: 11,
        center: new google.maps.LatLng(28.667508, 77.121255),
        mapTypeId: google.maps.MapTypeId.TERRAIN
      };
      
      map = new google.maps.Map(document.getElementById('map-canvas'),mapOptions);
      
      for(var i=1;i<71;i++){
        plotConstituency(i);
      }
      
      var dragable_marker = new google.maps.Marker({
        position : new google.maps.LatLng(28.667508, 77.1212552),
        map : map,
        draggable : true
      });

      google.maps.event.addListener( dragable_marker, 'dragend', function( e ) {
         	getConstituency(dragable_marker.getPosition().lat(),dragable_marker.getPosition().lng());
      });

    }

    google.maps.event.addDomListener(window, 'load', initialize);

    </script>

  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>

